// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int       @id @default(autoincrement())
  name      String
  username  String    @unique
  email     String    @unique
  bio       String?
  location  String?
  interests String[]  @default([])
  password  String
  avatar    String?
  hasCompletedOnboarding Boolean @default(false)
  themeId   Int?
  customThemeSettings Json?
  points    Int       @default(0)
  totalPointsEarned Int @default(0)
  loginStreak Int     @default(0)
  lastLoginAt DateTime?
  createdAt DateTime  @default(now())
  emotionMode String @default("auto")
  manualEmotion String?
  manualEmotionColor String?
  posts     Post[]
  comments  Comment[]
  likes     Like[]
  reactions Reaction[]
  commentReactions CommentReaction[]
  requestedFriendships Friendship[] @relation("friendRequester")
  receivedFriendships  Friendship[] @relation("friendAddressee")
  notifications        Notification[]
  messages             Message[]
  conversations        ConversationParticipant[]
  preferences          UserPreference?
  projects             Project[]
  squadMemberships     SquadMember[]
  userBadges           UserBadge[]
  feedbackAuthored     Feedback[]
  feedbackVotes        FeedbackVote[]
  theme                Theme?     @relation(fields: [themeId], references: [id])
  userItems            UserItem[]
  interactions         UserInteraction[]
  coverImageUrl            String?
  termStats               UserTermStats[]
  relationsAsUser1        UserRelation[] @relation("UserRelationUser1")
  relationsAsUser2        UserRelation[] @relation("UserRelationUser2")
  ambiguousReferencesAuthored AmbiguousReference[] @relation("AmbiguousReferenceAuthor")
  ambiguousReferenceCandidates AmbiguousReferenceCandidate[] @relation("AmbiguousReferenceTarget")
}

model Post {
  id        Int        @id @default(autoincrement())
  content   String
  image     String?
  createdAt DateTime   @default(now())
  authorId  Int
  author    User       @relation(fields: [authorId], references: [id])
  comments  Comment[]
  likes     Like[]
  reactions Reaction[]
  tags      String[]   @default([])
  hashtags  String[]   @default([])
  type      PostType   @default(NORMAL)
  squadId   Int?
  squad     Squad?     @relation(fields: [squadId], references: [id])
  projectId Int?
  project   Project?   @relation(fields: [projectId], references: [id])
  ambiguousReferences AmbiguousReference[] @relation("PostAmbiguousReferences")
  emotion   String?
  emotionColor String?
}

model Comment {
  id        Int       @id @default(autoincrement())
  content   String
  createdAt DateTime  @default(now())
  authorId  Int
  postId    Int
  author    User      @relation(fields: [authorId], references: [id])
  post      Post      @relation(fields: [postId], references: [id])
  reactions CommentReaction[]
}

model Like {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  userId    Int
  postId    Int
  user      User     @relation(fields: [userId], references: [id])
  post      Post     @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
}

enum ReactionType {
  MACANUDO
  MESSIRVE
  JAJAJA
  DE_UNA
  QUE_BOLUDO
  QUE_BAJON
}

enum PostType {
  NORMAL
  HELP_REQUEST
  PROJECT_UPDATE
}

model Reaction {
  id        Int          @id @default(autoincrement())
  type      ReactionType
  createdAt DateTime     @default(now())
  userId    Int
  postId    Int
  user      User         @relation(fields: [userId], references: [id])
  post      Post         @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
}

model CommentReaction {
  id        Int          @id @default(autoincrement())
  type      ReactionType
  createdAt DateTime     @default(now())
  userId    Int
  commentId Int
  user      User         @relation(fields: [userId], references: [id])
  comment   Comment      @relation(fields: [commentId], references: [id])

  @@unique([userId, commentId])
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
}

model Friendship {
  id           Int               @id @default(autoincrement())
  requesterId  Int
  addresseeId  Int
  status       FriendshipStatus  @default(PENDING)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  requester    User              @relation("friendRequester", fields: [requesterId], references: [id])
  addressee    User              @relation("friendAddressee", fields: [addresseeId], references: [id])
  relationCategory String?       // amigo, familia, trabajo, deporte, pareja, etc
  relationDetail   String?       // primo, hermana, colega, etc

  @@unique([requesterId, addresseeId])
}

enum NotificationType {
  REACTION
  MENTION
  MESSAGE
  REEL_SHARED
}

model Notification {
  id        Int              @id @default(autoincrement())
  type      NotificationType
  data      Json
  readAt    DateTime?
  createdAt DateTime         @default(now())
  userId    Int
  user      User             @relation(fields: [userId], references: [id])
}

model UserPreference {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  cardStyle   Json?
  theme       String?  // "light" | "dark" | custom palette key
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
}

enum InteractionType {
  REGISTER
  LOGIN
  POST_CREATED
  COMMENT_CREATED
  LIKE_GIVEN
}

model UserInteraction {
  id        Int             @id @default(autoincrement())
  userId    Int
  type      InteractionType
  weight    Int
  createdAt DateTime        @default(now())

  user      User            @relation(fields: [userId], references: [id])
}

model Theme {
  id                 Int      @id @default(autoincrement())
  key                String   @unique
  name               String
  primaryColor       String?
  secondaryColor     String?
  backgroundGradient String?
  decorations        Json?
  createdAt          DateTime @default(now())

  users              User[]
  shopItems          ShopItem[]
}

enum ShopItemCategory {
  THEME
  DECORATION
}

model ShopItem {
  id          Int               @id @default(autoincrement())
  key         String            @unique
  name        String
  description String?
  category    ShopItemCategory
  pricePoints Int
  assetData   Json?
  themeKey    String?
  theme       Theme?            @relation(fields: [themeKey], references: [key])
  userItems   UserItem[]
}

model UserItem {
  id         Int       @id @default(autoincrement())
  userId     Int
  itemId     Int
  acquiredAt DateTime  @default(now())
  equipped   Boolean   @default(false)

  user       User      @relation(fields: [userId], references: [id])
  item       ShopItem  @relation(fields: [itemId], references: [id])
}

enum SquadType {
  FOTO
  FITNESS
  IDIOMAS
  GENERAL
}

enum SquadRole {
  MEMBER
  ADMIN
}

model Squad {
  id          Int           @id @default(autoincrement())
  name        String
  slug        String        @unique
  description String
  tags        String[]      @default([])
  type        SquadType     @default(GENERAL)
  createdAt   DateTime      @default(now())

  members     SquadMember[]
  posts       Post[]
}

model SquadMember {
  userId   Int
  squadId  Int
  role     SquadRole @default(MEMBER)
  joinedAt DateTime  @default(now())

  user  User  @relation(fields: [userId], references: [id])
  squad Squad @relation(fields: [squadId], references: [id])

  @@id([userId, squadId])
}

enum ProjectCategory {
  PERSONAL
  CREATIVO
  SALUD
  ESTUDIO
  OTRO
}

enum ProjectVisibility {
  PUBLIC
  FRIENDS
  PRIVATE
}

model Project {
  id          Int               @id @default(autoincrement())
  userId      Int
  title       String
  description String?
  category    ProjectCategory   @default(OTRO)
  targetDate  DateTime?
  visibility  ProjectVisibility @default(PUBLIC)
  needsHelp   Boolean           @default(false)
  progress    Int               @default(0)

  user   User  @relation(fields: [userId], references: [id])
  posts  Post[]
}

model Badge {
  id          Int         @id @default(autoincrement())
  code        String      @unique
  name        String
  description String?
  icon        String?
  createdAt   DateTime    @default(now())

  userBadges  UserBadge[]
}

model UserBadge {
  userId   Int
  badgeId  Int
  grantedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  badge Badge @relation(fields: [badgeId], references: [id])

  @@id([userId, badgeId])
}

enum FeedbackStatus {
  NEW
  REVIEWING
  IN_PROGRESS
  DONE
}

model Feedback {
  id          Int            @id @default(autoincrement())
  authorId    Int
  title       String
  description String
  votes       Int            @default(0)
  status      FeedbackStatus @default(NEW)
  createdAt   DateTime       @default(now())

  author        User           @relation(fields: [authorId], references: [id])
  feedbackVotes FeedbackVote[]
}

model FeedbackVote {
  userId     Int
  feedbackId Int
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  feedback Feedback @relation(fields: [feedbackId], references: [id])

  @@id([userId, feedbackId])
}

model Hashtag {
  id         Int      @id @default(autoincrement())
  canonical  String   @unique
  display    String
  useCount   Int      @default(0)
  lastUsedAt DateTime @default(now())
}

model TermGlobal {
  id          Int      @id @default(autoincrement())
  term        String
  normalized  String   @unique
  totalCount  Int      @default(0)
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())
}

model TermTopicStats {
  id             Int    @id @default(autoincrement())
  termNormalized String
  tag            String
  count          Int    @default(0)

  @@unique([termNormalized, tag])
}

model UserTermStats {
  id           Int      @id @default(autoincrement())
  userId       Int
  term         String
  normalized   String
  isProperName Boolean  @default(false)
  count        Int      @default(0)
  lastSeenAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, normalized])
  @@index([userId, normalized])
}

model UserRelation {
  id                Int      @id @default(autoincrement())
  user1Id           Int
  user2Id           Int
  score             Float    @default(0)
  lastInteractionAt DateTime @default(now())

  user1 User @relation("UserRelationUser1", fields: [user1Id], references: [id])
  user2 User @relation("UserRelationUser2", fields: [user2Id], references: [id])

  @@unique([user1Id, user2Id])
}

model AmbiguousReference {
  id        Int      @id @default(autoincrement())
  postId    Int
  authorId  Int
  label     String
  sentiment String
  kind      String
  createdAt DateTime @default(now())

  post   Post @relation("PostAmbiguousReferences", fields: [postId], references: [id])
  author User @relation("AmbiguousReferenceAuthor", fields: [authorId], references: [id])

  candidates AmbiguousReferenceCandidate[]
}

model AmbiguousReferenceCandidate {
  id           Int      @id @default(autoincrement())
  referenceId  Int
  targetUserId Int
  confidence   Float    @default(0)

  reference AmbiguousReference @relation(fields: [referenceId], references: [id])
  target    User               @relation("AmbiguousReferenceTarget", fields: [targetUserId], references: [id])
}

model Conversation {
  id           Int                        @id @default(autoincrement())
  isDirect     Boolean                    @default(true)
  createdAt    DateTime                   @default(now())
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             Int          @id @default(autoincrement())
  conversationId Int
  userId         Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
}

model Message {
  id             Int          @id @default(autoincrement())
  content        String
  createdAt      DateTime     @default(now())
  senderId       Int
  conversationId Int
  sender         User         @relation(fields: [senderId], references: [id])
  conversation   Conversation @relation(fields: [conversationId], references: [id])
}
